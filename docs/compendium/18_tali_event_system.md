# TALI Design Hub — Section 9: Event System & Message Bus

## 18. Event System & Message Bus
> Defines TALI’s event-driven communication model, message routing architecture, and how components interact asynchronously across internal and external systems.

### 18.1 Overview
TALI operates on a **fully event-driven architecture (EDA)**, allowing modular components to communicate asynchronously through structured events. This ensures scalability, fault isolation, and real-time responsiveness across learning, persona, and integration layers.

The event system connects all runtime domains:
- Core internal events (learning loops, hypothesis lifecycle, sandbox results).
- System telemetry (metrics, status, and logging).
- External events from MQTT, HA APIs, or Messenger I/O.

---

### 18.2 Event Flow Summary
```
[External Input] → [Ingress Adapter] → [Event Broker] → [Core Subscribers] → [Processing Units] → [Emit Results]
```

| Direction | Source | Example |
|------------|---------|----------|
| **Inbound** | MQTT, HA API, Discord, Voice, File Watchers | Device events, commands, sensor updates |
| **Internal** | Learning Engine, Sandbox, Persona | Model updates, predictions, hypothesis validation |
| **Outbound** | HA API, MQTT, Grafana, Messenger | Actions, metrics, responses, logs |

---

### 18.3 Message Bus Components
| Component | Technology | Description |
|------------|-------------|--------------|
| **Primary Bus** | **Spring Application Events** | Lightweight in-memory pub/sub between micro-modules. |
| **External Broker** | **MQTT (EMQX or Mosquitto)** | Core bridge for Home Assistant and IoT device communication. |
| **Async Queue (Optional)** | **Kafka** | For replayable, long-lived analytical workloads or distributed learning. |
| **Realtime Cache** | **Redis Streams / PubSub** | Fast transient event propagation for volatile state or session context. |

---

### 18.4 Event Lifecycle
Every event in TALI passes through a consistent lifecycle, ensuring observability and replayability.

```
[Create] → [Validate] → [Enrich] → [Dispatch] → [Consume] → [Acknowledge]
```

| Phase | Description |
|--------|--------------|
| **Create** | An event is generated by an adapter or module. |
| **Validate** | Schema validation ensures structure and safety. |
| **Enrich** | Metadata is appended — trace ID, initiator, context, timestamps. |
| **Dispatch** | Sent via ApplicationEventPublisher, Redis, or MQTT. |
| **Consume** | Subscribers process events asynchronously using virtual threads. |
| **Acknowledge** | Completion metrics are logged; retries triggered if needed. |

---

### 18.5 Event Schema & Metadata
Each event carries a structured JSON envelope:
```json
{
  "id": "evt-20251027-00123",
  "timestamp": "2025-10-27T18:23:44Z",
  "source": "tali.learning",
  "type": "LEARNING_HYPOTHESIS_TESTED",
  "context": {
    "room": "living_room",
    "initiator": "adam",
    "sandbox_id": "sandbox-42"
  },
  "payload": {
    "hypothesis_id": "hyp-9087",
    "score": 0.82,
    "passed": true
  },
  "trace": {
    "correlation_id": "trace-a8f91b",
    "sequence": 42
  }
}
```

---

### 18.6 Event Namespaces
| Namespace | Description | Example Event |
|------------|-------------|----------------|
| `tali.core.*` | Core orchestration and lifecycle control. | `tali.core.startup.complete` |
| `tali.learning.*` | Reinforcement engine events and sandbox evaluations. | `tali.learning.hypothesis.tested` |
| `tali.persona.*` | Persona adjustments and emotional state transitions. | `tali.persona.overlay.updated` |
| `tali.voice.*` | Speech recognition, TTS, and audio routing. | `tali.voice.speech.recognized` |
| `tali.messenger.*` | Text-based communications and action responses. | `tali.messenger.message.received` |
| `tali.analytics.*` | Metrics emission and data pipeline updates. | `tali.analytics.metric.exported` |
| `tali.security.*` | Auth, trust updates, and anomaly detection. | `tali.security.session.flagged` |

---

### 18.7 Event Routing & Filtering
- **Routing Keys:** Follow hierarchical dot notation for granular filtering.
- **Wildcard Subscriptions:** Modules can subscribe to entire namespaces (e.g., `tali.learning.*`).
- **Filtering:** Subscribers may apply conditions (e.g., initiator, confidence > X, type == “anomaly”).
- **Replay & Retention:** Critical events (learning, persona, actions) stored in Postgres and Kafka for historical replay.

---

### 18.8 Observability & Debugging
- Each event carries a **trace ID** propagated through all subsystems for end-to-end visibility.
- Grafana Loki dashboards visualize event throughput, failures, and latency.
- Prometheus metrics track:
  - Event count per namespace.
  - Processing latency.
  - Retry rates and error frequency.
- Actuator endpoints expose `/events/live` and `/events/history` for inspection.

---

### 18.9 Security & Reliability
- All messages signed with internal service key.
- TLS-secured MQTT and Kafka connections.
- Event payloads are PII-redacted before persistence or external transmission.
- Dead-letter queues for failed deliveries.
- Automatic backpressure handling via virtual thread pools.

---

### 18.10 Future Enhancements
- Distributed tracing via OpenTelemetry spans per event.
- Event prioritization for critical automations.
- Schema registry for event versioning.
- Adaptive routing based on system load.

---

*(Section 18 defines TALI’s asynchronous event system and message bus, enabling modular, observable, and resilient real-time communication across its cognitive and operational layers.)*

